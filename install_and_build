#!/usr/bin/env bash
# 빌드 중 에러 발생 시 즉시 중단
set -e

echo "--- 1. Flutter SDK 다운로드 및 환경 설정 시작 ---"

# 변수를 안전하게 export 및 쿼트(Quote) 처리
export FLUTTER_VERSION="stable"
export FLUTTER_DIR="$HOME/flutter"

# Flutter 폴더 생성
mkdir -p "$FLUTTER_DIR"

# Flutter SDK 다운로드 및 압축 해제
curl -sSL "https://storage.googleapis.com/flutter_infra_release/releases/$FLUTTER_VERSION/linux/flutter_linux_latest-stable.tar.xz" -o /tmp/flutter.tar.xz
tar -xJf /tmp/flutter.tar.xz -C "$HOME"

# PATH 환경 변수에 Flutter 경로 추가
export PATH="$FLUTTER_DIR/bin:$FLUTTER_DIR/bin/cache/dart-sdk/bin:$PATH"

# Flutter 웹 지원 활성화 및 precache
flutter config --enable-web
flutter precache --web

echo "--- 2. Flutter 프로젝트 빌드 시작 ---"
# 패키지 다운로드 및 빌드
flutter pub get
flutter build web --release

echo "--- 빌드 완료! Netlify가 build/web을 게시합니다. ---"